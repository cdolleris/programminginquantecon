<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>31&nbsp; Likelihood Exercises – Notes for 3611: Programming in Quantitative Economics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./extra_extra_exercises.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ecba78ac1d23ec93bb40517a5fbc1f6e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./problemsets.html">Problem sets</a></li><li class="breadcrumb-item"><a href="./likelihood_exercises.html"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Likelihood Exercises</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Notes for 3611: Programming in Quantitative Economics</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./lectures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to the Course</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting_started_with_r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting Started with R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basic_programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Basic Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./programming_w_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Programming with Functions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./efficiency_and_parallel_computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Program Efficiency and Parallel Computing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction_to_simulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Introduction to Simulation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rootfinding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Root-finding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numericaloptimization1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Numerical Optimization 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numericaloptimization2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Numerical Optimization 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./constrainedandpitfalls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Constrained Optimization and Pitfalls in Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cpp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Integration of C++ Code with Rcpp</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Creating R packages with RStudio</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./problemsets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem sets</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./problemset1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Exercise set 1</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./problemset2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Exercise set 2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./problemset3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Exercise set 3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./problemset4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Exercise set 4</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./problemset5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Exercise set 5</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./problemset6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Exercise set 6</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2020.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Ordinary exam 2020</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2021.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ordinary exam 2021</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2021re.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Retake exam 2021</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2022.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Ordinary exam 2022</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2022re.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Retake exam 2022</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2023.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Ordinary exam 2023</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2023re.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Retake exam 2023</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2024.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Ordinary exam 2024</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exam2024retake.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Retake exam 2024</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extra_exercises.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Extra exercises</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_exercises.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Advanced exercises</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extra_extra_exercises.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Extra extra exercises</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./likelihood_exercises.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Likelihood Exercises</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#exercise-set-16-advanced-econometric-likelihoods-and-optimization" id="toc-exercise-set-16-advanced-econometric-likelihoods-and-optimization" class="nav-link active" data-scroll-target="#exercise-set-16-advanced-econometric-likelihoods-and-optimization"><span class="header-section-number">32</span> Exercise Set 16: Advanced Econometric Likelihoods and Optimization</a>
  <ul class="collapse">
<li><a href="#probit-model-likelihood-medium-hard" id="toc-probit-model-likelihood-medium-hard" class="nav-link" data-scroll-target="#probit-model-likelihood-medium-hard"><span class="header-section-number">32.1</span> <strong>(1) Probit Model Likelihood (Medium-Hard)</strong></a></li>
  <li><a href="#garch11-model-likelihood-hard" id="toc-garch11-model-likelihood-hard" class="nav-link" data-scroll-target="#garch11-model-likelihood-hard"><span class="header-section-number">32.2</span> <strong>(2) GARCH(1,1) Model Likelihood (Hard)</strong></a></li>
  <li><a href="#heckman-selection-model-likelihood-extremely-hard" id="toc-heckman-selection-model-likelihood-extremely-hard" class="nav-link" data-scroll-target="#heckman-selection-model-likelihood-extremely-hard"><span class="header-section-number">32.3</span> <strong>(3) Heckman Selection Model Likelihood (Extremely Hard)</strong></a></li>
  <li><a href="#vector-autoregression-var-likelihood-multivariate-normal-hard" id="toc-vector-autoregression-var-likelihood-multivariate-normal-hard" class="nav-link" data-scroll-target="#vector-autoregression-var-likelihood-multivariate-normal-hard"><span class="header-section-number">32.4</span> <strong>(4) Vector Autoregression (VAR) Likelihood (Multivariate Normal) (Hard)</strong></a></li>
  </ul>
</li>
  <li>
<a href="#exercise-set-17-integrated-econometric-modeling-problems" id="toc-exercise-set-17-integrated-econometric-modeling-problems" class="nav-link" data-scroll-target="#exercise-set-17-integrated-econometric-modeling-problems"><span class="header-section-number">33</span> Exercise Set 17: Integrated Econometric Modeling Problems</a>
  <ul class="collapse">
<li><a href="#logistic-regression-full-implementation-hard" id="toc-logistic-regression-full-implementation-hard" class="nav-link" data-scroll-target="#logistic-regression-full-implementation-hard"><span class="header-section-number">33.1</span> <strong>(1) Logistic Regression: Full Implementation (Hard)</strong></a></li>
  <li><a href="#ar1-model-with-students-t-errors-extremely-hard" id="toc-ar1-model-with-students-t-errors-extremely-hard" class="nav-link" data-scroll-target="#ar1-model-with-students-t-errors-extremely-hard"><span class="header-section-number">33.2</span> <strong>(2) AR(1) Model with Student’s t-errors (Extremely Hard)</strong></a></li>
  <li><a href="#zero-inflated-poisson-zip-regression-likelihood-extremely-hard" id="toc-zero-inflated-poisson-zip-regression-likelihood-extremely-hard" class="nav-link" data-scroll-target="#zero-inflated-poisson-zip-regression-likelihood-extremely-hard"><span class="header-section-number">33.3</span> <strong>(3) Zero-Inflated Poisson (ZIP) Regression Likelihood (Extremely Hard)</strong></a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./problemsets.html">Problem sets</a></li><li class="breadcrumb-item"><a href="./likelihood_exercises.html"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Likelihood Exercises</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Likelihood Exercises</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="exercise-set-16-advanced-econometric-likelihoods-and-optimization" class="level1" data-number="32"><h1 data-number="32">
<span class="header-section-number">32</span> Exercise Set 16: Advanced Econometric Likelihoods and Optimization</h1>
<section id="probit-model-likelihood-medium-hard" class="level2" data-number="32.1"><h2 data-number="32.1" class="anchored" data-anchor-id="probit-model-likelihood-medium-hard">
<span class="header-section-number">32.1</span> <strong>(1) Probit Model Likelihood (Medium-Hard)</strong>
</h2>
<ul>
<li>A Probit model for a binary outcome <span class="math inline">\(y_i \in \{0,1\}\)</span> is given by <span class="math inline">\(P(y_i=1 | \mathbf{x}_i) = \Phi(\mathbf{x}_i'\boldsymbol{\beta})\)</span>, where <span class="math inline">\(\Phi(\cdot)\)</span> is the standard normal CDF, <span class="math inline">\(\mathbf{x}_i\)</span> is a vector of explanatory variables (including an intercept), and <span class="math inline">\(\boldsymbol{\beta}\)</span> is a vector of parameters.</li>
<li>The log-likelihood for <span class="math inline">\(n\)</span> observations is <span class="math inline">\(LL(\boldsymbol{\beta}) = \sum_{i=1}^n [y_i \log(\Phi(\mathbf{x}_i'\boldsymbol{\beta})) + (1-y_i) \log(1-\Phi(\mathbf{x}_i'\boldsymbol{\beta}))]\)</span>.</li>
<li>Data:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="va">X2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="va">X_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1</span>, <span class="va">X2</span><span class="op">)</span> <span class="co"># Design matrix with intercept</span></span>
<span><span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="op">-</span><span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">linear_predictor</span> <span class="op">&lt;-</span> <span class="va">X_matrix</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true</span></span>
<span><span class="va">prob_y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">linear_predictor</span><span class="op">)</span></span>
<span><span class="va">Y_binary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="va">prob_y1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><ol type="a">
<li>Write an R function <code>fProbitNegLogLik(vBeta, mX, vY)</code> that calculates the negative log-likelihood for the Probit model. <code>vBeta</code> is the parameter vector, <code>mX</code> is the design matrix, and <code>vY</code> is the binary outcome vector.</li>
</ol></li>
<li><ol start="2" type="a">
<li>Use <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> with method “BFGS” to find the MLEs for <span class="math inline">\(\boldsymbol{\beta}\)</span>. Choose appropriate starting values (e.g., a vector of zeros).</li>
</ol></li>
<li><ol start="3" type="a">
<li>Compare your estimated <span class="math inline">\(\boldsymbol{\beta}\)</span> with the coefficients from <code>glm(Y_binary ~ X1 + X2, family = binomial(link = "probit"))</code>.</li>
</ol></li>
<li><ol start="4" type="a">
<li>(Hard) Analytically derive the gradient of the Probit log-likelihood with respect to <span class="math inline">\(\boldsymbol{\beta}\)</span>. Recall that <span class="math inline">\(\frac{d\Phi(z)}{dz} = \phi(z)\)</span> (standard normal PDF). The gradient for one observation is <span class="math inline">\(\frac{y_i - \Phi(\mathbf{x}_i'\boldsymbol{\beta})}{\Phi(\mathbf{x}_i'\boldsymbol{\beta})(1-\Phi(\mathbf{x}_i'\boldsymbol{\beta}))} \phi(\mathbf{x}_i'\boldsymbol{\beta}) \mathbf{x}_i\)</span>. Write an R function for this gradient (summed over observations) and use it in <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> via the <code>gr</code> argument. Does it converge faster or to a more precise solution?</li>
</ol></li>
<li><ol start="5" type="a">
<li>(C++) Implement the Probit negative log-likelihood calculation in C++ (e.g., <code>probit_neg_log_lik_cpp(arma::vec beta, arma::mat X, arma::vec Y)</code>). You can use <code>R::pnorm</code> and <code>R::dnorm</code> for <span class="math inline">\(\Phi\)</span> and <span class="math inline">\(\phi\)</span>. Compare its speed to the R version for a single evaluation.</li>
</ol></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="va">X2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="va">X_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1</span>, <span class="va">X2</span><span class="op">)</span> <span class="co"># matrix with intercept</span></span>
<span><span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="op">-</span><span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">linear_predictor</span> <span class="op">&lt;-</span> <span class="va">X_matrix</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true</span></span>
<span><span class="va">prob_y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">linear_predictor</span><span class="op">)</span></span>
<span><span class="va">Y_binary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="va">prob_y1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#a </span></span>
<span><span class="va">fProbitNegLogLik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vBeta</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span></span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">+</span> <span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dSum</span><span class="op">)</span></span>
<span>  <span class="co"># alternative</span></span>
<span>  <span class="co"># return(-sum(vY * log(pnorm(mX %*% vBeta)) + (1 - vY) * log(1 - pnorm(mX %*% vBeta))))</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#b</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">fProbitNegLogLik</span>, mX <span class="op">=</span> <span class="va">X_matrix</span>, vY <span class="op">=</span> <span class="va">Y_binary</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="co">#&gt; [1] -0.6124990  1.6593570 -0.7099176</span></span>
<span></span>
<span><span class="co">#c</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">Y_binary</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"probit"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span></span>
<span><span class="co">#&gt; (Intercept)          X1          X2 </span></span>
<span><span class="co">#&gt;  -0.6125001   1.6593555  -0.7099154</span></span>
<span></span>
<span><span class="co">#d</span></span>
<span><span class="va">fProbitGrad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vBeta</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span></span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">dProb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">+</span> <span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">dProb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">dProb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">dProb</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">mX</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dSum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">fProbitNegLogLik</span>, gr <span class="op">=</span> <span class="va">fProbitGrad</span>, mX <span class="op">=</span> <span class="va">X_matrix</span>, vY <span class="op">=</span> <span class="va">Y_binary</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="co">#&gt; [1] -0.6124989  1.6593568 -0.7099176</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> arma<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> probit_neg_log_lik_cpp<span class="op">(</span>vec beta<span class="op">,</span> mat X<span class="op">,</span> vec Y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> Y<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dSum <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  vec linear_term <span class="op">=</span> X <span class="op">*</span> beta<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  vec dProb <span class="op">=</span> zeros<span class="op">&lt;</span>vec<span class="op">&gt;(</span>X<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    dProb<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> R<span class="op">::</span>pnorm<span class="op">(</span>linear_term<span class="op">(</span>i<span class="op">),</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    dSum <span class="op">+=</span> Y<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> log<span class="op">(</span>dProb<span class="op">[</span>i<span class="op">])</span> <span class="op">+</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> Y<span class="op">[</span>i<span class="op">])</span> <span class="op">*</span> log<span class="op">(</span><span class="dv">1</span> <span class="op">-</span> dProb<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(-</span>dSum<span class="op">);</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#e</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org">Rcpp</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: pakke 'Rcpp' blev bygget under R version 4.3.3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RcppCore/RcppArmadillo">RcppArmadillo</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: pakke 'RcppArmadillo' blev bygget under R version 4.3.3</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp</a></span><span class="op">(</span><span class="st">"likelihood_exercises.cpp"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">probit_neg_log_lik_cpp</span><span class="op">(</span><span class="va">beta_true</span>, <span class="va">X_matrix</span>, <span class="va">Y_binary</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 66.87324</span></span>
<span><span class="fu">fProbitNegLogLik</span><span class="op">(</span><span class="va">beta_true</span>, <span class="va">X_matrix</span>, <span class="va">Y_binary</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 66.87324</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="garch11-model-likelihood-hard" class="level2" data-number="32.2"><h2 data-number="32.2" class="anchored" data-anchor-id="garch11-model-likelihood-hard">
<span class="header-section-number">32.2</span> <strong>(2) GARCH(1,1) Model Likelihood (Hard)</strong>
</h2>
<ul>
<li>Recall the GARCH(1,1) model: <span class="math inline">\(r_t = \sigma_t \epsilon_t\)</span>, where <span class="math inline">\(\epsilon_t \sim N(0,1)\)</span> (iid) <span class="math inline">\(\sigma_t^2 = \omega + \alpha r_{t-1}^2 + \beta \sigma_{t-1}^2\)</span>
</li>
<li>Parameters are <span class="math inline">\(\boldsymbol{\theta} = (\omega, \alpha, \beta)\)</span>. Constraints: <span class="math inline">\(\omega &gt; 0, \alpha \ge 0, \beta \ge 0\)</span>, and <span class="math inline">\(\alpha + \beta &lt; 1\)</span> (for stationarity).</li>
<li>The conditional log-likelihood for <span class="math inline">\(r_t\)</span> given past information (and <span class="math inline">\(\sigma_t^2\)</span>) is <span class="math inline">\(-\frac{1}{2} (\log(2\pi) + \log(\sigma_t^2) + \frac{r_t^2}{\sigma_t^2})\)</span>. The total log-likelihood is the sum over <span class="math inline">\(t=1, \dots, T\)</span>.</li>
<li>For <span class="math inline">\(t=1\)</span>, an initial <span class="math inline">\(\sigma_1^2\)</span> is needed. Often, the unconditional variance <span class="math inline">\(\sigma^2 = \frac{\omega}{1-\alpha-\beta}\)</span> is used if the process is stationary, or simply <span class="math inline">\(r_0^2\)</span> is set to the sample variance of <span class="math inline">\(r_t\)</span> and <span class="math inline">\(\sigma_1^2\)</span> is calculated using the GARCH equation from <span class="math inline">\(r_0^2\)</span> and a starting <span class="math inline">\(\sigma_0^2\)</span> (e.g., also sample variance).</li>
<li>Data: Use S&amp;P 500 daily log-returns. You can download data using <code>quantmod</code> package if allowed, or use a pre-saved dataset. For this exercise, let’s simulate some GARCH-like data:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">T_garch</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">omega_true</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>; <span class="va">alpha_true</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>; <span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fl">0.85</span></span>
<span><span class="va">sigma2_garch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">T_garch</span><span class="op">)</span></span>
<span><span class="va">r_garch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">T_garch</span><span class="op">)</span></span>
<span><span class="va">sigma2_garch</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">omega_true</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha_true</span> <span class="op">-</span> <span class="va">beta_true</span><span class="op">)</span> <span class="co"># Unconditional variance</span></span>
<span><span class="va">r_garch</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_garch</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">t_idx</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">T_garch</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sigma2_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">omega_true</span> <span class="op">+</span> <span class="va">alpha_true</span> <span class="op">*</span> <span class="va">r_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">beta_true</span> <span class="op">*</span> <span class="va">sigma2_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">r_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><ol type="a">
<li>Write an R function <code>fGARCH11NegLogLik(vParams, vReturns, sigma2_initial)</code> that computes the negative log-likelihood. <code>vParams</code> is <code>c(omega, alpha, beta)</code>. Handle the recursive calculation of <span class="math inline">\(\sigma_t^2\)</span>.</li>
</ol></li>
<li>
<ol start="2" type="a">
<li>Reparameterize the parameters to enforce constraints:</li>
</ol>
<ul>
<li><span class="math inline">\(\omega = \exp(\tilde{\omega})\)</span></li>
<li><span class="math inline">\(\alpha = \exp(\tilde{\alpha}) / (1 + \exp(\tilde{\alpha}) + \exp(\tilde{\beta}))\)</span></li>
<li>
<span class="math inline">\(\beta = \exp(\tilde{\beta}) / (1 + \exp(\tilde{\alpha}) + \exp(\tilde{\beta}))\)</span> (This ensures <span class="math inline">\(\omega&gt;0, \alpha&gt;0, \beta&gt;0, \alpha+\beta &lt; 1\)</span>. A simpler common reparam is <span class="math inline">\(\alpha=\exp(\tilde{\alpha})/(1+\exp(\tilde{\alpha}))\)</span> and <span class="math inline">\(\beta=\exp(\tilde{\beta})/(1+\exp(\tilde{\beta}))\)</span>, then check <span class="math inline">\(\alpha+\beta&lt;1\)</span> inside LL and return large penalty if not met, or use <code>L-BFGS-B</code> on transformed <span class="math inline">\(\alpha, \beta\)</span> in [0,1] and <span class="math inline">\(\omega&gt;0\)</span>, with an additional check for sum &lt; 1). Modify your likelihood function to take reparameterized inputs <span class="math inline">\(\tilde{\boldsymbol{\theta}} = (\tilde{\omega}, \tilde{\alpha}, \tilde{\beta})\)</span>.</li>
</ul>
</li>
<li><ol start="3" type="a">
<li>Use <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> with “BFGS” to find the MLEs of <span class="math inline">\(\tilde{\boldsymbol{\theta}}\)</span> using <code>r_garch</code> and an appropriate <code>sigma2_initial</code> (e.g., sample variance of <code>r_garch</code>).</li>
</ol></li>
<li><ol start="4" type="a">
<li>Transform the estimated <span class="math inline">\(\tilde{\boldsymbol{\theta}}^*\)</span> back to <span class="math inline">\(\boldsymbol{\theta}^* = (\omega^*, \alpha^*, \beta^*)\)</span>. Compare with <code>omega_true, alpha_true, beta_true</code>.</li>
</ol></li>
<li><ol start="5" type="a">
<li>(Extremely Hard C++) Implement the GARCH(1,1) negative log-likelihood calculation in C++ using <code>RcppArmadillo</code>. This will involve a loop to calculate the <span class="math inline">\(\sigma_t^2\)</span> sequence. Compare its speed for a single evaluation against the R version.</li>
</ol></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#data </span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">T_garch</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">omega_true</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>; <span class="va">alpha_true</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>; <span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fl">0.85</span></span>
<span><span class="va">sigma2_garch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">T_garch</span><span class="op">)</span></span>
<span><span class="va">r_garch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">T_garch</span><span class="op">)</span></span>
<span><span class="va">sigma2_garch</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">omega_true</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha_true</span> <span class="op">-</span> <span class="va">beta_true</span><span class="op">)</span> <span class="co"># unconditional variance</span></span>
<span><span class="va">r_garch</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_garch</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">t_idx</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">T_garch</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sigma2_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">omega_true</span> <span class="op">+</span> <span class="va">alpha_true</span> <span class="op">*</span> <span class="va">r_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">beta_true</span> <span class="op">*</span> <span class="va">sigma2_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">r_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_garch</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#a</span></span>
<span><span class="va">fGARCH11NegLogLik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vParams</span>, <span class="va">vReturns</span>, <span class="va">sigma2_initial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dOmega</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">dAlpha</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">dBeta</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">vSigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vReturns</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">vSigma2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sigma2_initial</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vReturns</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dOmega</span> <span class="op">+</span> <span class="va">dAlpha</span> <span class="op">*</span> <span class="va">vReturns</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">dBeta</span> <span class="op">*</span> <span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">vReturns</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dSum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#b</span></span>
<span><span class="va">fGARCH11NegLogLikRepar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vParams</span>, <span class="va">vReturns</span>, <span class="va">sigma2_initial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dOmega</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">dAlpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dBeta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">vSigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vReturns</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">vSigma2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sigma2_initial</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vReturns</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dOmega</span> <span class="op">+</span> <span class="va">dAlpha</span> <span class="op">*</span> <span class="va">vReturns</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">dBeta</span> <span class="op">*</span> <span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">vReturns</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">vSigma2</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dSum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#c</span></span>
<span><span class="va">dPar_tilde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">fGARCH11NegLogLikRepar</span>, sigma2_initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">r_garch</span><span class="op">)</span>, vReturns <span class="op">=</span> <span class="va">r_garch</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span><span class="op">$</span><span class="va">par</span></span>
<span></span>
<span></span>
<span><span class="co">#d</span></span>
<span><span class="va">dOmega_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dPar_tilde</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dAlpha_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dPar_tilde</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dPar_tilde</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dPar_tilde</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dBeta_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dPar_tilde</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dPar_tilde</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dPar_tilde</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Omega est: "</span>, <span class="va">dOmega_star</span>, <span class="st">" vs. true: "</span>, <span class="va">omega_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Omega est: 0.188330580842483 vs. true: 0.1"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Alpha est: "</span>, <span class="va">dAlpha_star</span>, <span class="st">" vs. true: "</span>, <span class="va">alpha_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Alpha est: 0.120768680865144 vs. true: 0.1"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Beta est: "</span>, <span class="va">dBeta_star</span>, <span class="st">" vs. true: "</span>, <span class="va">beta_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Beta est: 0.768485839334849 vs. true: 0.85"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> fGARCH11NegLogLik_cpp<span class="op">(</span>vec vParams<span class="op">,</span> vec vReturns<span class="op">,</span> <span class="dt">double</span> sigma2_initial<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dOmega <span class="op">=</span> vParams<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dAlpha <span class="op">=</span> vParams<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dBeta <span class="op">=</span> vParams<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> vReturns<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dSum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  vec vSigma2 <span class="op">=</span> zeros<span class="op">&lt;</span>vec<span class="op">&gt;(</span>vReturns<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  vSigma2<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> sigma2_initial<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dPi <span class="op">=</span> atan<span class="op">(</span><span class="dv">1</span><span class="op">)*</span><span class="dv">4</span><span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> t <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> t <span class="op">&lt;</span> n<span class="op">;</span> t<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    vSigma2<span class="op">[</span>t<span class="op">]</span> <span class="op">=</span> dOmega <span class="op">+</span> dAlpha <span class="op">*</span> pow<span class="op">(</span>vReturns<span class="op">[</span>t<span class="op">-</span><span class="dv">1</span><span class="op">],</span> <span class="dv">2</span><span class="op">)</span> <span class="op">+</span> dBeta <span class="op">*</span> vSigma2<span class="op">[</span>t<span class="op">-</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    dSum <span class="op">=</span> dSum <span class="op">-</span> <span class="fl">0.5</span><span class="op">*(</span>log<span class="op">(</span><span class="dv">2</span><span class="op">*</span>dPi<span class="op">)</span> <span class="op">+</span> log<span class="op">(</span>vSigma2<span class="op">[</span>t<span class="op">])</span> <span class="op">+</span> pow<span class="op">(</span>vReturns<span class="op">[</span>t<span class="op">],</span> <span class="dv">2</span><span class="op">)</span> <span class="op">/</span> vSigma2<span class="op">[</span>t<span class="op">]);</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(-</span>dSum<span class="op">);</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org">Rcpp</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RcppCore/RcppArmadillo">RcppArmadillo</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp</a></span><span class="op">(</span><span class="st">"likelihood_exercises.cpp"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fGARCH11NegLogLik</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">omega_true</span>, <span class="va">alpha_true</span>, <span class="va">beta_true</span><span class="op">)</span>, <span class="va">r_garch</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">r_garch</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 830.2781</span></span>
<span><span class="fu">fGARCH11NegLogLik_cpp</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">omega_true</span>, <span class="va">alpha_true</span>, <span class="va">beta_true</span><span class="op">)</span>, <span class="va">r_garch</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">r_garch</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 830.2781</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="heckman-selection-model-likelihood-extremely-hard" class="level2" data-number="32.3"><h2 data-number="32.3" class="anchored" data-anchor-id="heckman-selection-model-likelihood-extremely-hard">
<span class="header-section-number">32.3</span> <strong>(3) Heckman Selection Model Likelihood (Extremely Hard)</strong>
</h2>
<ul>
<li>The Heckman model addresses sample selection bias. It involves two equations:
<ol type="1">
<li>Selection equation (Probit): <span class="math inline">\(z_i^* = \mathbf{w}_i'\boldsymbol{\gamma} + u_i\)</span>, where <span class="math inline">\(z_i=1\)</span> if <span class="math inline">\(z_i^* &gt; 0\)</span> (observed), <span class="math inline">\(0\)</span> otherwise. <span class="math inline">\(u_i \sim N(0,1)\)</span>.</li>
<li>Outcome equation (Linear regression, observed only if <span class="math inline">\(z_i=1\)</span>): <span class="math inline">\(y_i = \mathbf{x}_i'\boldsymbol{\beta} + \epsilon_i\)</span>, where <span class="math inline">\(\epsilon_i \sim N(0, \sigma^2)\)</span>.</li>
</ol>
<ul>
<li>
<span class="math inline">\(u_i\)</span> and <span class="math inline">\(\epsilon_i\)</span> are bivariate normal with correlation <span class="math inline">\(\rho\)</span>. <span class="math inline">\(corr(u_i, \epsilon_i) = \rho\)</span>.</li>
</ul>
</li>
<li>The log-likelihood for one observation <span class="math inline">\(i\)</span> (where <span class="math inline">\(y_i\)</span> is observed if <span class="math inline">\(z_i=1\)</span>) is:
<ul>
<li>If <span class="math inline">\(z_i=0\)</span>: <span class="math inline">\(LL_i = \log(1 - \Phi(\mathbf{w}_i'\boldsymbol{\gamma}))\)</span>
</li>
<li>If <span class="math inline">\(z_i=1\)</span>: <span class="math inline">\(LL_i = \log \left( \frac{1}{\sigma} \phi\left(\frac{y_i - \mathbf{x}_i'\boldsymbol{\beta}}{\sigma}\right) \Phi\left(\frac{\mathbf{w}_i'\boldsymbol{\gamma} + \frac{\rho}{\sigma}(y_i - \mathbf{x}_i'\boldsymbol{\beta})}{\sqrt{1-\rho^2}}\right) \right)\)</span>
</li>
</ul>
</li>
<li>Parameters are <span class="math inline">\(\boldsymbol{\theta} = (\boldsymbol{\gamma}', \boldsymbol{\beta}', \sigma, \rho)'\)</span>. Constraints: <span class="math inline">\(\sigma &gt; 0, -1 &lt; \rho &lt; 1\)</span>.</li>
<li>Data: You would typically simulate this.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">789</span><span class="op">)</span></span>
<span><span class="va">N_heck</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_heck</span><span class="op">)</span>; <span class="va">W_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">W1</span><span class="op">)</span> <span class="co"># Selection vars</span></span>
<span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_heck</span><span class="op">)</span>; <span class="va">X_matrix_outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1</span><span class="op">)</span> <span class="co"># Outcome vars</span></span>
<span><span class="va">gamma_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>; <span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>; <span class="va">sigma_true</span> <span class="op">&lt;-</span> <span class="fl">1.5</span>; <span class="va">rho_true</span> <span class="op">&lt;-</span> <span class="fl">0.6</span></span>
<span>    </span>
<span><span class="co"># Simulate errors</span></span>
<span><span class="va">errors</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span><span class="va">N_heck</span>, mu<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, Sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">rho_true</span><span class="op">*</span><span class="va">sigma_true</span>, <span class="va">rho_true</span><span class="op">*</span><span class="va">sigma_true</span>, <span class="va">sigma_true</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">u_i</span> <span class="op">&lt;-</span> <span class="va">errors</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">epsilon_i</span> <span class="op">&lt;-</span> <span class="va">errors</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>    </span>
<span><span class="va">z_star</span> <span class="op">&lt;-</span> <span class="va">W_matrix</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">gamma_true</span> <span class="op">+</span> <span class="va">u_i</span></span>
<span><span class="va">Z_select</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">z_star</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">Y_outcome</span> <span class="op">&lt;-</span> <span class="va">X_matrix_outcome</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true</span> <span class="op">+</span> <span class="va">epsilon_i</span></span>
<span><span class="va">Y_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Z_select</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">Y_outcome</span>, <span class="cn">NA</span><span class="op">)</span> <span class="co"># Only observe Y if Z_select is 1</span></span>
<span><span class="va">df_heckman</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">Y_observed</span>, <span class="va">X1</span>, <span class="va">W1</span>, <span class="va">Z_select</span><span class="op">)</span></span>
<span><span class="va">df_heckman_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">df_heckman</span>, <span class="va">Z_select</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># data for outcome eq.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><ol type="a">
<li>Write an R function <code>fHeckmanNegLogLik(vParams, dfData, mSelectionVars, mOutcomeVars)</code> that calculates the total negative log-likelihood. <code>vParams</code> contains all parameters. <code>dfData</code> should contain the outcome <span class="math inline">\(y\)</span>, the selection indicator <span class="math inline">\(z\)</span>, and covariates. <code>mSelectionVars</code> and <code>mOutcomeVars</code> are column names/indices for <span class="math inline">\(\mathbf{w}\)</span> and <span class="math inline">\(\mathbf{x}\)</span>.</li>
</ol></li>
<li><ol start="2" type="a">
<li>Implement reparameterizations for <span class="math inline">\(\sigma = \exp(\tilde{\sigma})\)</span> and <span class="math inline">\(\rho = \tanh(\tilde{\rho}) = \frac{e^{\tilde{\rho}} - e^{-\tilde{\rho}}}{e^{\tilde{\rho}} + e^{-\tilde{\rho}}}\)</span>. Modify your likelihood function.</li>
</ol></li>
<li><ol start="3" type="a">
<li>Use <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> (“BFGS” or “Nelder-Mead” due to complexity) to estimate the reparameterized parameters using the simulated data. This is notoriously difficult to optimize; choose starting values carefully (e.g., from separate Probit and OLS on selected sample, <span class="math inline">\(\tilde{\sigma}=\log(\text{sd-res-ols})\)</span>, <span class="math inline">\(\tilde{\rho}=0\)</span>).</li>
</ol></li>
<li><ol start="4" type="a">
<li>Transform estimates back and compare to true values.</li>
</ol></li>
<li>(This problem is very challenging due to the complexity of the likelihood and potential for numerical instability. Focus on correctly writing the likelihood parts).</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">789</span><span class="op">)</span></span>
<span><span class="va">N_heck</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_heck</span><span class="op">)</span>; <span class="va">W_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">W1</span><span class="op">)</span> <span class="co"># Selection vars</span></span>
<span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_heck</span><span class="op">)</span>; <span class="va">X_matrix_outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1</span><span class="op">)</span> <span class="co"># Outcome vars</span></span>
<span><span class="va">gamma_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>; <span class="va">beta_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>; <span class="va">sigma_true</span> <span class="op">&lt;-</span> <span class="fl">1.5</span>; <span class="va">rho_true</span> <span class="op">&lt;-</span> <span class="fl">0.6</span></span>
<span>    </span>
<span><span class="co"># Simulate errors</span></span>
<span><span class="va">errors</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span><span class="va">N_heck</span>, mu<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, Sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">rho_true</span><span class="op">*</span><span class="va">sigma_true</span>, <span class="va">rho_true</span><span class="op">*</span><span class="va">sigma_true</span>, <span class="va">sigma_true</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">u_i</span> <span class="op">&lt;-</span> <span class="va">errors</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">epsilon_i</span> <span class="op">&lt;-</span> <span class="va">errors</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>    </span>
<span><span class="va">z_star</span> <span class="op">&lt;-</span> <span class="va">W_matrix</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">gamma_true</span> <span class="op">+</span> <span class="va">u_i</span></span>
<span><span class="va">Z_select</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">z_star</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">Y_outcome</span> <span class="op">&lt;-</span> <span class="va">X_matrix_outcome</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true</span> <span class="op">+</span> <span class="va">epsilon_i</span></span>
<span><span class="va">Y_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Z_select</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">Y_outcome</span>, <span class="cn">NA</span><span class="op">)</span> <span class="co"># Only observe Y if Z_select is 1</span></span>
<span><span class="va">df_heckman</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">Y_observed</span>, <span class="va">X1</span>, <span class="va">W1</span>, <span class="va">Z_select</span><span class="op">)</span></span>
<span><span class="va">df_heckman_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">df_heckman</span>, <span class="va">Z_select</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># data for outcome eq.</span></span>
<span></span>
<span><span class="co">#a + b</span></span>
<span><span class="va">fHeckmanNegLogLik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vParams</span>, <span class="va">dfData</span>, <span class="va">mSelectionVars</span>, <span class="va">mOutcomeVars</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#vParams contains all parameters.</span></span>
<span>  <span class="co">#dfData should contain the outcome y, the selection indicator z, and covariates.</span></span>
<span>  <span class="co">#mSelectionVars and mOutcomeVars are column names/indices for w and x.</span></span>
<span>  <span class="va">vGamma</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">vBeta</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span>  <span class="va">dSigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">dRho</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">vY</span> <span class="op">&lt;-</span> <span class="va">dfData</span><span class="op">[</span>, <span class="va">mOutcomeVars</span><span class="op">]</span></span>
<span>  <span class="va">vZ</span> <span class="op">&lt;-</span> <span class="va">dfData</span><span class="op">[</span>, <span class="va">mSelectionVars</span><span class="op">]</span></span>
<span>  <span class="va">vX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dfData</span><span class="op">$</span><span class="va">X1</span><span class="op">)</span></span>
<span>  <span class="va">vW</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dfData</span><span class="op">$</span><span class="va">W1</span><span class="op">)</span></span>
<span>  <span class="va">dLlSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">vZ</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">dLlSum</span> <span class="op">&lt;-</span> <span class="va">dLlSum</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">vW</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vGamma</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">dLlSum</span> <span class="op">&lt;-</span> <span class="va">dLlSum</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">dSigma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">vX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">dSigma</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="va">vW</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vGamma</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">dRho</span> <span class="op">/</span> <span class="va">dSigma</span> <span class="op">*</span> <span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="va">vX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">dRho</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dLlSum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># c</span></span>
<span><span class="va">vParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">fHeckmanNegLogLik</span>, dfData <span class="op">=</span> <span class="va">df_heckman</span>, mSelectionVars <span class="op">=</span> <span class="fl">4</span>, mOutcomeVars <span class="op">=</span> <span class="fl">1</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span><span class="op">$</span><span class="va">par</span></span>
<span></span>
<span><span class="co"># d</span></span>
<span><span class="va">gamma_star</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">beta_star</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="va">sigma_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">rho_star</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">vParams</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Gamma est: "</span>, <span class="va">gamma_star</span>, <span class="st">" vs. true: "</span>, <span class="va">gamma_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Gamma est: 0.434869076735787 vs. true: 0.5"</span></span>
<span><span class="co">#&gt; [2] "Gamma est: -1.17799006585571 vs. true: -1"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Beta est: "</span>, <span class="va">beta_star</span>, <span class="st">" vs. true: "</span>, <span class="va">beta_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Beta est: 0.964253846625409 vs. true: 1"</span></span>
<span><span class="co">#&gt; [2] "Beta est: 1.921924920477 vs. true: 2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Sigma est: "</span>, <span class="va">sigma_star</span>, <span class="st">" vs. true: "</span>, <span class="va">sigma_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Sigma est: 1.53499526849203 vs. true: 1.5"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Rho est: "</span>, <span class="va">rho_star</span>, <span class="st">" vs. true. "</span>, <span class="va">rho_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Rho est: 0.597269354835849 vs. true. 0.6"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="vector-autoregression-var-likelihood-multivariate-normal-hard" class="level2" data-number="32.4"><h2 data-number="32.4" class="anchored" data-anchor-id="vector-autoregression-var-likelihood-multivariate-normal-hard">
<span class="header-section-number">32.4</span> <strong>(4) Vector Autoregression (VAR) Likelihood (Multivariate Normal) (Hard)</strong>
</h2>
<ul>
<li>Consider a VAR(1) model for two variables <span class="math inline">\(y_{1t}, y_{2t}\)</span>: <span class="math inline">\(\mathbf{y}_t = \mathbf{c} + A \mathbf{y}_{t-1} + \boldsymbol{\epsilon}_t\)</span>, where <span class="math inline">\(\mathbf{y}_t = \begin{pmatrix} y_{1t} \\ y_{2t} \end{pmatrix}\)</span>, <span class="math inline">\(\mathbf{c} = \begin{pmatrix} c_1 \\ c_2 \end{pmatrix}\)</span>, <span class="math inline">\(A = \begin{pmatrix} a_{11} &amp; a_{12} \\ a_{21} &amp; a_{22} \end{pmatrix}\)</span>, and <span class="math inline">\(\boldsymbol{\epsilon}_t \sim N(\mathbf{0}, \Sigma)\)</span>, with <span class="math inline">\(\Sigma = \begin{pmatrix} \sigma_{11} &amp; \sigma_{12} \\ \sigma_{21} &amp; \sigma_{22} \end{pmatrix}\)</span> being symmetric positive definite.</li>
<li>The conditional log-likelihood for one observation <span class="math inline">\(\mathbf{y}_t\)</span> given <span class="math inline">\(\mathbf{y}_{t-1}\)</span> is: <span class="math inline">\(LL_t = -\frac{k}{2}\log(2\pi) - \frac{1}{2}\log(|\Sigma|) - \frac{1}{2}(\mathbf{y}_t - \mathbf{c} - A \mathbf{y}_{t-1})'\Sigma^{-1}(\mathbf{y}_t - \mathbf{c} - A \mathbf{y}_{t-1})\)</span>, where <span class="math inline">\(k=2\)</span> (number of variables).</li>
<li>Parameters: <span class="math inline">\(\mathbf{c}\)</span> (2 params), <span class="math inline">\(A\)</span> (4 params), and unique elements of <span class="math inline">\(\Sigma\)</span> (3 params: <span class="math inline">\(\sigma_{11}, \sigma_{22}, \sigma_{12}\)</span> as <span class="math inline">\(\sigma_{21}=\sigma_{12}\)</span>). Total 9 parameters.</li>
<li>Constraints: <span class="math inline">\(\Sigma\)</span> must be positive definite. (Often ensure by parameterizing Cholesky factor <span class="math inline">\(L\)</span> s.t. <span class="math inline">\(\Sigma = LL'\)</span>).</li>
<li>Data: Use <code>Canada</code> dataset from <code>vars</code> package, first two variables <code>e</code> and <code>prod</code>, differenced.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.pfaffikus.de">vars</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Canada</span><span class="op">)</span></span>
<span><span class="va">Canada_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Canada</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"e"</span>,<span class="st">"prod"</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Y_var_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">Canada_diff</span><span class="op">)</span></span>
<span><span class="va">T_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Y_var_data</span><span class="op">)</span> <span class="op">-</span><span class="fl">1</span> <span class="co"># Number of observations for LL sum</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>(Alternatively, simulate VAR data)</code></pre>
<ul>
<li><ol type="a">
<li>Write an R function <code>fVAR1NegLogLik(vParams, mY)</code> for the negative log-likelihood. <code>vParams</code> needs to be carefully unpacked into <span class="math inline">\(\mathbf{c}, A, \Sigma\)</span>.</li>
</ol></li>
<li><ol start="2" type="a">
<li>For <span class="math inline">\(\Sigma\)</span>, parameterize its Cholesky factor <span class="math inline">\(L = \begin{pmatrix} l_{11} &amp; 0 \\ l_{21} &amp; l_{22} \end{pmatrix}\)</span>. To ensure <span class="math inline">\(l_{11}&gt;0, l_{22}&gt;0\)</span>, use <span class="math inline">\(l_{11}=\exp(\tilde{l}_{11}), l_{22}=\exp(\tilde{l}_{22})\)</span>. <span class="math inline">\(l_{21}\)</span> is unconstrained. <span class="math inline">\(\Sigma = LL'\)</span>. The parameters in <code>vParams</code> related to <span class="math inline">\(\Sigma\)</span> will be <span class="math inline">\((\tilde{l}_{11}, l_{21}, \tilde{l}_{22})\)</span>.</li>
</ol></li>
<li><ol start="3" type="a">
<li>Use <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> to estimate the reparameterized parameters. This will be slow and sensitive to starting values. (OLS estimates can be good starting values for <span class="math inline">\(c\)</span> and <span class="math inline">\(A\)</span>).</li>
</ol></li>
<li><ol start="4" type="a">
<li>(Conceptual) How would you derive the gradient for this likelihood? (Matrix calculus needed).</li>
</ol></li>
<li><ol start="5" type="a">
<li>(C++ <code>RcppArmadillo</code>) Implement the VAR(1) negative log-likelihood calculation in C++. This would involve matrix operations for which Armadillo is well-suited (<code>arma::solve</code>, <code>arma::log_det</code>).</li>
</ol></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.pfaffikus.de">vars</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: pakke 'vars' blev bygget under R version 4.3.3</span></span>
<span><span class="co">#&gt; Warning: pakke 'strucchange' blev bygget under R version 4.3.3</span></span>
<span><span class="co">#&gt; Warning: pakke 'zoo' blev bygget under R version 4.3.3</span></span>
<span><span class="co">#&gt; Warning: pakke 'sandwich' blev bygget under R version 4.3.3</span></span>
<span><span class="co">#&gt; Warning: pakke 'urca' blev bygget under R version 4.3.3</span></span>
<span><span class="co">#&gt; Warning: pakke 'lmtest' blev bygget under R version 4.3.3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Canada</span><span class="op">)</span></span>
<span><span class="va">Canada_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Canada</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"e"</span>,<span class="st">"prod"</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Y_var_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">Canada_diff</span><span class="op">)</span></span>
<span><span class="va">T_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Y_var_data</span><span class="op">)</span> <span class="op">-</span><span class="fl">1</span> <span class="co"># Number of observations for LL sum</span></span>
<span></span>
<span><span class="co"># a + b</span></span>
<span><span class="va">fVAR1NegLogLik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vParams</span>, <span class="va">mY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vC</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">mA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">mSigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span>, <span class="va">vParams</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">mSigma</span> <span class="op">&lt;-</span> <span class="va">mSigma</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mSigma</span><span class="op">)</span></span>
<span>  <span class="va">iK</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mY</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mY</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">-</span> <span class="va">iK</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/det.html">det</a></span><span class="op">(</span><span class="va">mSigma</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mY</span><span class="op">[</span><span class="va">t</span>, <span class="op">]</span> <span class="op">-</span> <span class="va">vC</span> <span class="op">-</span> <span class="va">mA</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mY</span><span class="op">[</span><span class="va">t</span> <span class="op">-</span> <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">mSigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="op">(</span><span class="va">mY</span><span class="op">[</span><span class="va">t</span>, <span class="op">]</span> <span class="op">-</span> <span class="va">vC</span> <span class="op">-</span> <span class="va">mA</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mY</span><span class="op">[</span><span class="va">t</span> <span class="op">-</span> <span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dSum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># c</span></span>
<span><span class="va">start_c_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">start_A_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">start_L_tilde_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">start_params_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start_c_var</span>, <span class="va">start_A_var</span>, <span class="va">start_L_tilde_var</span><span class="op">)</span></span>
<span><span class="va">optim_res_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="va">start_params_var</span>, <span class="va">fVAR1NegLogLik</span>, mY <span class="op">=</span> <span class="va">Y_var_data</span>, method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>, lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">6</span><span class="op">)</span>, <span class="op">-</span><span class="fl">30</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="op">-</span><span class="fl">30</span><span class="op">)</span>, upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">optim_res_var</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="co">#&gt; [1]  0.10033694  0.06371892  0.67883561  0.12431749  0.19044272  0.27667404</span></span>
<span><span class="co">#&gt; [7] -0.96917510  0.01153122 -0.38346578</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> fVAR1NegLogLik<span class="op">(</span>vec vParams<span class="op">,</span> mat mY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  vec vC <span class="op">=</span> zeros<span class="op">&lt;</span>vec<span class="op">&gt;(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  vC<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> vParams<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  vC<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> vParams<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  mat mA<span class="op">(</span><span class="dv">2</span><span class="op">,</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  mA<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> vParams<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  mA<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> vParams<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  mA<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> vParams<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  mA<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> vParams<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  mat mSigma<span class="op">(</span><span class="dv">2</span><span class="op">,</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  mSigma<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> exp<span class="op">(</span>vParams<span class="op">[</span><span class="dv">6</span><span class="op">]);</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  mSigma<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  mSigma<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">)</span> <span class="op">=</span> vParams<span class="op">[</span><span class="dv">7</span><span class="op">];</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  mSigma<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> exp<span class="op">(</span>vParams<span class="op">[</span><span class="dv">8</span><span class="op">]);</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  mSigma <span class="op">=</span> mSigma <span class="op">*</span> mSigma<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> iK <span class="op">=</span> mY<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dPi <span class="op">=</span> atan<span class="op">(</span><span class="dv">1</span><span class="op">)*</span><span class="dv">4</span><span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dSum <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>arma<span class="op">::</span>uword t <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> t <span class="op">&lt;</span> mY<span class="op">.</span>n_rows<span class="op">;</span> t<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    vec <span class="dt">u_t</span> <span class="op">=</span> mY<span class="op">.</span>row<span class="op">(</span>t<span class="op">).</span>t<span class="op">()</span> <span class="op">-</span> vC <span class="op">-</span> mA <span class="op">*</span> mY<span class="op">.</span>row<span class="op">(</span>t<span class="op">-</span><span class="dv">1</span><span class="op">).</span>t<span class="op">();</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    dSum <span class="op">=</span> dSum <span class="op">-</span> iK <span class="op">/</span> <span class="fl">2.0</span> <span class="op">*</span> log<span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> dPi<span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> log<span class="op">(</span>det<span class="op">(</span>mSigma<span class="op">))</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> as_scalar<span class="op">(</span>trans<span class="op">(</span><span class="dt">u_t</span><span class="op">)</span> <span class="op">*</span> mSigma<span class="op">.</span>i<span class="op">()</span> <span class="op">*</span> <span class="op">(</span><span class="dt">u_t</span><span class="op">));</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(-</span>dSum<span class="op">);</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org">Rcpp</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RcppCore/RcppArmadillo">RcppArmadillo</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp</a></span><span class="op">(</span><span class="st">"likelihood_exercises.cpp"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="exercise-set-17-integrated-econometric-modeling-problems" class="level1" data-number="33"><h1 data-number="33">
<span class="header-section-number">33</span> Exercise Set 17: Integrated Econometric Modeling Problems</h1>
<section id="logistic-regression-full-implementation-hard" class="level2" data-number="33.1"><h2 data-number="33.1" class="anchored" data-anchor-id="logistic-regression-full-implementation-hard">
<span class="header-section-number">33.1</span> <strong>(1) Logistic Regression: Full Implementation (Hard)</strong>
</h2>
<ul>
<li>A Logistic model for a binary outcome <span class="math inline">\(y_i \in \{0,1\}\)</span> is <span class="math inline">\(P(y_i=1 | \mathbf{x}_i) = \Lambda(\mathbf{x}_i'\boldsymbol{\beta}) = \frac{\exp(\mathbf{x}_i'\boldsymbol{\beta})}{1+\exp(\mathbf{x}_i'\boldsymbol{\beta})}\)</span>.</li>
<li>The log-likelihood is <span class="math inline">\(LL(\boldsymbol{\beta}) = \sum_{i=1}^n [y_i (\mathbf{x}_i'\boldsymbol{\beta}) - \log(1+\exp(\mathbf{x}_i'\boldsymbol{\beta}))]\)</span>.</li>
<li>Data (same as Probit example):</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">N_log</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">X1_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_log</span><span class="op">)</span></span>
<span><span class="va">X2_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N_log</span><span class="op">)</span></span>
<span><span class="va">X_matrix_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1_log</span>, <span class="va">X2_log</span><span class="op">)</span> </span>
<span><span class="va">beta_true_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="op">-</span><span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">linear_predictor_log</span> <span class="op">&lt;-</span> <span class="va">X_matrix_log</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true_log</span></span>
<span><span class="va">prob_y1_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">linear_predictor_log</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">linear_predictor_log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Y_binary_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N_log</span>, <span class="fl">1</span>, <span class="va">prob_y1_log</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<strong>Tasks:</strong>
<ul>
<li><ol type="a">
<li>
<strong>R Likelihood:</strong> Write an R function <code>fLogisticNegLogLik(vBeta, mX, vY)</code> for the negative log-likelihood.</li>
</ol></li>
<li>
<ol start="2" type="a">
<li>
<strong>R Gradient &amp; Hessian:</strong> Analytically derive the gradient vector and Hessian matrix of the log-likelihood.</li>
</ol>
<ul>
<li>Gradient: <span class="math inline">\(\nabla LL(\boldsymbol{\beta}) = \sum_{i=1}^n (y_i - \Lambda(\mathbf{x}_i'\boldsymbol{\beta})) \mathbf{x}_i\)</span>.</li>
<li>Hessian: <span class="math inline">\(H(\boldsymbol{\beta}) = -\sum_{i=1}^n \Lambda(\mathbf{x}_i'\boldsymbol{\beta})(1-\Lambda(\mathbf{x}_i'\boldsymbol{\beta})) \mathbf{x}_i \mathbf{x}_i'\)</span>. Write R functions <code>fLogisticGradient(vBeta, mX, vY)</code> and <code>fLogisticHessian(vBeta, mX, vY)</code>. For the Hessian, return the negative of it if your Newton-Raphson is set up for maximization using <span class="math inline">\(H^{-1}g\)</span>.</li>
</ul>
</li>
<li><ol start="3" type="a">
<li>
<strong>R Newton-Raphson:</strong> Implement the Newton-Raphson algorithm (for maximization) using your functions from (a)-(b) to find the MLEs for <span class="math inline">\(\boldsymbol{\beta}\)</span>. Your Newton function should take the target function (negative LL for minimization, or LL for maximization), gradient, Hessian, starting values, tolerance, and max iterations. It should return a list with optimal parameters, function value, and convergence status.</li>
</ol></li>
<li><ol start="4" type="a">
<li>
<strong><code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> Comparison:</strong> Use <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> with method “BFGS” and your negative log-likelihood from (a) and gradient from (b) (negated if <code>optim</code> minimizes). Compare the results and number of iterations/evaluations with your Newton-Raphson.</li>
</ol></li>
<li><ol start="5" type="a">
<li>
<strong>C++ Likelihood:</strong> Implement <code>fLogisticNegLogLik</code> in C++ (<code>logistic_neg_log_lik_cpp</code>) using <code>RcppArmadillo</code>. Use <code>arma::log1p(exp(Xb))</code> for <span class="math inline">\(\log(1+\exp(\mathbf{x}_i'\boldsymbol{\beta}))\)</span> for numerical stability if <span class="math inline">\(\mathbf{x}_i'\boldsymbol{\beta}\)</span> is large. Compare speed of one evaluation.</li>
</ol></li>
<li><ol start="6" type="a">
<li>
<strong>R Package:</strong> Create a small R package named “MyLogistic” containing your R functions <code>fLogisticNegLogLik</code>, <code>fLogisticGradient</code>, <code>fLogisticHessian</code>, your Newton-Raphson solver, and the C++ likelihood function (with an R wrapper). Document the main estimation function (e.g., your Newton-Raphson solver). Ensure C++ dependencies are correctly specified in <code>DESCRIPTION</code>. Build and test the package.</li>
</ol></li>
</ul>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">N_log</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">X1_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_log</span><span class="op">)</span></span>
<span><span class="va">X2_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N_log</span><span class="op">)</span></span>
<span><span class="va">X_matrix_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1_log</span>, <span class="va">X2_log</span><span class="op">)</span> </span>
<span><span class="va">beta_true_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="op">-</span><span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">linear_predictor_log</span> <span class="op">&lt;-</span> <span class="va">X_matrix_log</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true_log</span></span>
<span><span class="va">prob_y1_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">linear_predictor_log</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">linear_predictor_log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Y_binary_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N_log</span>, <span class="fl">1</span>, <span class="va">prob_y1_log</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#a</span></span>
<span><span class="va">fLogisticLogLik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vBeta</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">+</span> <span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dSum</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#  alternatively</span></span>
<span>  <span class="co">#return(-sum(vY * mX %*% vBeta - log(1 + exp(mX %*% vBeta))))</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#b</span></span>
<span><span class="va">fLogisticGradient</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vBeta</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dProb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vBeta</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">+</span> <span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">dProb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">mX</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dSum</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># alternatively</span></span>
<span>  <span class="co"># return(t(mX) %*% (vY - dProb))</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fLogisticHessian</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vBeta</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dProb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mHessianSum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mX</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mX</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mHessianSum</span> <span class="op">&lt;-</span> <span class="va">mHessianSum</span> <span class="op">+</span> <span class="va">dProb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">dProb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">mX</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mX</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">mHessianSum</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># alternatively</span></span>
<span>  <span class="co"># return(- t(mX) %*% diag(as.numeric(dProb * (1 - dProb))) %*% mX)</span></span>
<span>  <span class="co"># return(-crossprod(mX, mX * as.numeric(dProb * (1 - dProb))))</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#c</span></span>
<span><span class="va">fNewton</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">fScore</span>, <span class="va">fHessian</span>, <span class="va">vY</span>, <span class="va">mX</span>, <span class="va">add.constant</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">init.vals</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">max.iter</span> <span class="op">=</span> <span class="fl">200</span>, <span class="va">dTol</span> <span class="op">=</span> <span class="fl">1e-9</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">vB</span> <span class="op">&lt;-</span> <span class="va">init.vals</span></span>
<span>  </span>
<span>  <span class="co"># Keep updating until stopping criterion or max iterations reached</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu">fScore</span><span class="op">(</span><span class="va">vB</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">dTol</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="va">i</span> <span class="op">&lt;</span> <span class="va">max.iter</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Newton-Raphson updating</span></span>
<span>    <span class="va">vB</span> <span class="op">&lt;-</span> <span class="va">vB</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="fu">fHessian</span><span class="op">(</span><span class="va">vB</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span>, <span class="fu">fScore</span><span class="op">(</span><span class="va">vB</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="co">#cat("At iteration", n, "the value of the parameter is:", dParam, "\n")</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="va">max.iter</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      beta_hat <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>      log_likelihood_opt <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>      score_opt <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      hessian_opt <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      log_likelihood_null <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      <span class="co">#predicted_probabilities = NULL,</span></span>
<span>      iterations <span class="op">=</span> <span class="va">i</span>,  </span>
<span>      msg <span class="op">=</span> <span class="st">"Algorithm failed to converge. Maximum iterations reached."</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      beta_hat <span class="op">=</span> <span class="va">vB</span>, </span>
<span>      log_likelihood_opt <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">vB</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span>, </span>
<span>      score_opt <span class="op">=</span> <span class="fu">fScore</span><span class="op">(</span><span class="va">vB</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span>,</span>
<span>      hessian_opt <span class="op">=</span> <span class="fu">fHessian</span><span class="op">(</span><span class="va">vB</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span>,</span>
<span>      log_likelihood_null <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">vB</span>, <span class="va">mX</span>, <span class="va">vY</span><span class="op">)</span>,</span>
<span>      <span class="co">#predicted_probabilities = exp(mX %*% vB) / (1 + exp(mX %*% vB)),</span></span>
<span>      iterations <span class="op">=</span> <span class="va">i</span>,  </span>
<span>      msg <span class="op">=</span> <span class="st">"Algorithm converged"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">fNewton</span><span class="op">(</span><span class="va">fLogisticLogLik</span>, <span class="va">fLogisticGradient</span>, <span class="va">fLogisticHessian</span>, vY <span class="op">=</span> <span class="va">Y_binary_log</span>, mX <span class="op">=</span> <span class="va">X_matrix_log</span>, init.vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $beta_hat</span></span>
<span><span class="co">#&gt;              X1_log    X2_log </span></span>
<span><span class="co">#&gt; -0.313394  1.609719 -0.590626 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log_likelihood_opt</span></span>
<span><span class="co">#&gt; [1] -100.5938</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $score_opt</span></span>
<span><span class="co">#&gt;                      X1_log        X2_log </span></span>
<span><span class="co">#&gt; -1.963759e-10  6.407941e-10 -1.425498e-10 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $hessian_opt</span></span>
<span><span class="co">#&gt;                     X1_log     X2_log</span></span>
<span><span class="co">#&gt; [1,] -33.374735  -4.528574 -16.508856</span></span>
<span><span class="co">#&gt; [2,]  -4.528574 -16.413238  -2.941622</span></span>
<span><span class="co">#&gt; [3,] -16.508856  -2.941622 -10.913058</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log_likelihood_null</span></span>
<span><span class="co">#&gt; [1] -100.5938</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $msg</span></span>
<span><span class="co">#&gt; [1] "Algorithm converged"</span></span>
<span></span>
<span><span class="co">#d</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">fLogisticLogLik</span>, gr <span class="op">=</span> <span class="va">fLogisticGradient</span>, mX <span class="op">=</span> <span class="va">X_matrix_log</span>, vY <span class="op">=</span> <span class="va">Y_binary_log</span>, method <span class="op">=</span> <span class="st">"BFGS"</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fnscale<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -0.3133828  1.6097293 -0.5906087</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] -100.5938</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       15        8 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> logistic_neg_log_lik_cpp<span class="op">(</span>vec vBeta<span class="op">,</span> mat mX<span class="op">,</span> vec vY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> dSum <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  vec linear_term <span class="op">=</span> mX <span class="op">*</span> vBeta<span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> vY<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    dSum <span class="op">+=</span> <span class="op">(</span>vY<span class="op">(</span>i<span class="op">)</span> <span class="op">*</span> linear_term<span class="op">(</span>i<span class="op">))</span> <span class="op">-</span> log<span class="op">(</span><span class="dv">1</span> <span class="op">+</span> exp<span class="op">(</span>linear_term<span class="op">(</span>i<span class="op">)));</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(</span>dSum<span class="op">);</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>f<span class="op">(</span>vB<span class="op">,</span> mX<span class="op">,</span> vY<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org">Rcpp</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RcppCore/RcppArmadillo">RcppArmadillo</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp</a></span><span class="op">(</span><span class="st">"likelihood_exercises.cpp"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fLogisticLogLik</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.313394</span>, <span class="fl">1.609719</span>, <span class="op">-</span><span class="fl">0.590626</span><span class="op">)</span>, <span class="va">X_matrix_log</span>, <span class="va">Y_binary_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -100.5938</span></span>
<span><span class="fu">logistic_neg_log_lik_cpp</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.313394</span>, <span class="fl">1.609719</span>, <span class="op">-</span><span class="fl">0.590626</span><span class="op">)</span>, <span class="va">X_matrix_log</span>, <span class="va">Y_binary_log</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -100.5938</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ar1-model-with-students-t-errors-extremely-hard" class="level2" data-number="33.2"><h2 data-number="33.2" class="anchored" data-anchor-id="ar1-model-with-students-t-errors-extremely-hard">
<span class="header-section-number">33.2</span> <strong>(2) AR(1) Model with Student’s t-errors (Extremely Hard)</strong>
</h2>
<ul>
<li>Consider an AR(1) model: <span class="math inline">\(y_t = \phi y_{t-1} + \epsilon_t\)</span>, where <span class="math inline">\(\epsilon_t \sim \text{i.i.d. Standardized Student's t}(\nu)\)</span>.</li>
<li>The PDF of a standardized Student’s t-distribution with <span class="math inline">\(\nu\)</span> degrees of freedom is <span class="math inline">\(f(\epsilon_t | \nu) = \frac{\Gamma((\nu+1)/2)}{\sqrt{\pi(\nu-2)}\Gamma(\nu/2)} \left(1 + \frac{\epsilon_t^2}{\nu-2}\right)^{-(\nu+1)/2}\)</span>. (Note: <span class="math inline">\(\sigma\)</span> (scale) is implicitly 1 here for the standardized version, or rather, scale is <span class="math inline">\(\sqrt{(\nu-2)/\nu}\)</span> times the scale of a non-standardized t to make variance 1. The formula given is for a t-dist scaled to have variance 1.)</li>
<li>Parameters are <span class="math inline">\(\boldsymbol{\theta} = (\phi, \nu)\)</span>. Constraints: <span class="math inline">\(|\phi|&lt;1\)</span> (stationarity), <span class="math inline">\(\nu &gt; 2\)</span> (for defined variance).</li>
<li>The conditional log-likelihood for <span class="math inline">\(y_t\)</span> given <span class="math inline">\(y_{t-1}\)</span> is <span class="math inline">\(\log f(y_t - \phi y_{t-1} | \nu)\)</span>. The total log-likelihood sums these over <span class="math inline">\(t=2, \dots, T\)</span> (conditioning on <span class="math inline">\(y_1\)</span>).</li>
<li>Data:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">800</span><span class="op">)</span></span>
<span><span class="va">T_ar</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">phi_true</span> <span class="op">&lt;-</span> <span class="fl">0.7</span></span>
<span><span class="va">nu_true</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># Degrees of freedom</span></span>
<span><span class="co"># Simulate standardized t errors (variance = 1)</span></span>
<span><span class="va">errors_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">rt</a></span><span class="op">(</span><span class="va">T_ar</span>, df <span class="op">=</span> <span class="va">nu_true</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">nu_true</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">nu_true</span><span class="op">)</span> </span>
<span><span class="va">y_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">T_ar</span><span class="op">)</span></span>
<span><span class="va">y_ar</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">errors_t</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">phi_true</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co"># Start from unconditional variance</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">t_idx</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">T_ar</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y_ar</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi_true</span> <span class="op">*</span> <span class="va">y_ar</span><span class="op">[</span><span class="va">t_idx</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">errors_t</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<strong>Tasks:</strong>
<ul>
<li><ol type="a">
<li>
<strong>R Likelihood:</strong> Write an R function <code>fAR1tNegLogLik(vParams, vY)</code> for the negative log-likelihood. <code>vParams = c(phi, nu)</code>. Use <code><a href="https://rdrr.io/r/base/Special.html">lgamma()</a></code> for <span class="math inline">\(\log(\Gamma(\cdot))\)</span>.</li>
</ol></li>
<li>
<ol start="2" type="a">
<li><strong>Reparameterization:</strong></li>
</ol>
<ul>
<li>
<span class="math inline">\(\phi = \tanh(\tilde{\phi})\)</span> (ensures <span class="math inline">\(|\phi|&lt;1\)</span>)</li>
<li>
<span class="math inline">\(\nu = 2 + \exp(\tilde{\nu})\)</span> (ensures <span class="math inline">\(\nu&gt;2\)</span>) Modify your likelihood to take <span class="math inline">\(\tilde{\boldsymbol{\theta}} = (\tilde{\phi}, \tilde{\nu})\)</span>.</li>
</ul>
</li>
<li><ol start="3" type="a">
<li>
<strong>Numerical Derivatives:</strong> Use <code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html">numDeriv::grad()</a></code> and <code><a href="https://rdrr.io/pkg/numDeriv/man/hessian.html">numDeriv::hessian()</a></code> (if allowed/available) to compute the gradient and Hessian of the <em>reparameterized</em> negative log-likelihood at a test point (e.g., <span class="math inline">\(\tilde{\phi}=0, \tilde{\nu}=\log(3)\)</span> which means <span class="math inline">\(\phi=0, \nu=5\)</span>).</li>
</ol></li>
<li><ol start="4" type="a">
<li>
<strong>Custom Newton-Raphson (on reparameterized LL):</strong> Implement Newton-Raphson using the numerical derivatives from (c) to estimate <span class="math inline">\(\tilde{\boldsymbol{\theta}}\)</span>. If numerical derivatives are too slow or unstable for the Hessian within the loop, you might use BFGS update for Hessian or just use <code>optim</code>.</li>
</ol></li>
<li><ol start="5" type="a">
<li>
<strong><code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> with Numerical Gradient:</strong> Use <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> with method “BFGS” and your <em>reparameterized</em> negative log-likelihood. Provide the gradient numerically using <code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html">numDeriv::grad()</a></code> in the <code>gr</code> argument of <code>optim</code>.</li>
</ol></li>
<li><ol start="6" type="a">
<li>
<strong>Results:</strong> Transform estimates back to <span class="math inline">\(\phi^*, \nu^*\)</span> and compare with true values.</li>
</ol></li>
<li><ol start="7" type="a">
<li>
<strong>C++ Likelihood (Challenge):</strong> Implement the core calculation <span class="math inline">\(\log f(\epsilon_t | \nu)\)</span> in C++. You will need <code>R::lgammafn</code> and <code>R::dt</code> (be careful with <code>R::dt</code>’s arguments, it might not be for standardized t directly, you might need to implement the PDF formula). Sum these in an outer C++ loop. Compare evaluation speed.</li>
</ol></li>
<li><ol start="8" type="a">
<li>
<strong>Simulation Study (Conceptual):</strong> How would you set up a small Monte Carlo simulation study to evaluate the performance (bias, RMSE) of your MLE estimator for <span class="math inline">\(\phi\)</span> and <span class="math inline">\(\nu\)</span> using, say, 100 replications of data like the one generated? (This part is about describing the loop and storage, not full implementation unless time allows). How could parallel processing help here?</li>
</ol></li>
</ul>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">800</span><span class="op">)</span></span>
<span><span class="va">T_ar</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">phi_true</span> <span class="op">&lt;-</span> <span class="fl">0.7</span></span>
<span><span class="va">nu_true</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># Degrees of freedom</span></span>
<span><span class="co"># Simulate standardized t errors (variance = 1)</span></span>
<span><span class="va">errors_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">rt</a></span><span class="op">(</span><span class="va">T_ar</span>, df <span class="op">=</span> <span class="va">nu_true</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">nu_true</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">nu_true</span><span class="op">)</span> </span>
<span><span class="va">y_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">T_ar</span><span class="op">)</span></span>
<span><span class="va">y_ar</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">errors_t</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">phi_true</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="co"># Start from unconditional variance</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">t_idx</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">T_ar</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y_ar</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi_true</span> <span class="op">*</span> <span class="va">y_ar</span><span class="op">[</span><span class="va">t_idx</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">errors_t</span><span class="op">[</span><span class="va">t_idx</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#a + b</span></span>
<span><span class="va">fAR1tNegLogLik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vParams</span>, <span class="va">vY</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dPhi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">tanh</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">dNu</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vParams</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">vEps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vEps</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">vY</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">-</span> <span class="va">dPhi</span> <span class="op">*</span> <span class="va">vY</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="op">(</span><span class="va">dNu</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="va">dNu</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">lgamma</a></span><span class="op">(</span><span class="va">dNu</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">dNu</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">vEps</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span> <span class="op">(</span><span class="va">dNu</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dSum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#c</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://optimizer.r-forge.r-project.org/">numDeriv</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fAR1tGrad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">vParams</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/numDeriv/man/grad.html">grad</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">vParams</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">fAR1tHess</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">vParams</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/numDeriv/man/hessian.html">hessian</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">vParams</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">fAR1tGrad</span><span class="op">(</span><span class="va">fAR1tNegLogLik</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>, vY <span class="op">=</span> <span class="va">y_ar</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -353.44783  -12.69966</span></span>
<span><span class="fu">fAR1tHess</span><span class="op">(</span><span class="va">fAR1tNegLogLik</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>, vY <span class="op">=</span> <span class="va">y_ar</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]     [,2]</span></span>
<span><span class="co">#&gt; [1,] 205.88262  3.80849</span></span>
<span><span class="co">#&gt; [2,]   3.80849 23.23789</span></span>
<span></span>
<span><span class="co">#d</span></span>
<span><span class="va">fNewton</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">fScore</span>, <span class="va">fHessian</span>, <span class="va">init.vals</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">max.iter</span> <span class="op">=</span> <span class="fl">200</span>, <span class="va">dTol</span> <span class="op">=</span> <span class="fl">1e-9</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">vPars</span> <span class="op">&lt;-</span> <span class="va">init.vals</span></span>
<span>  </span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu">fScore</span><span class="op">(</span><span class="va">f</span>, <span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">dTol</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="va">i</span> <span class="op">&lt;</span> <span class="va">max.iter</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vPars</span> <span class="op">&lt;-</span> <span class="va">vPars</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="fu">fHessian</span><span class="op">(</span><span class="va">f</span>, <span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span>, <span class="fu">fScore</span><span class="op">(</span><span class="va">f</span>, <span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="va">max.iter</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      curr_params <span class="op">=</span> <span class="va">vPars</span>, </span>
<span>      curr_log_likelihood_opt <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span>, </span>
<span>      curr_score_opt <span class="op">=</span> <span class="fu">fScore</span><span class="op">(</span><span class="va">f</span>, <span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>      curr_hessian_opt <span class="op">=</span> <span class="fu">fHessian</span><span class="op">(</span><span class="va">f</span>, <span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>      iterations <span class="op">=</span> <span class="va">i</span>,  </span>
<span>      msg <span class="op">=</span> <span class="st">"Algorithm failed to converge. Maximum iterations reached."</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      params <span class="op">=</span> <span class="va">vPars</span>, </span>
<span>      log_likelihood_opt <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span>, </span>
<span>      score_opt <span class="op">=</span> <span class="fu">fScore</span><span class="op">(</span><span class="va">f</span>, <span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>      hessian_opt <span class="op">=</span> <span class="fu">fHessian</span><span class="op">(</span><span class="va">f</span>, <span class="va">vPars</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>      iterations <span class="op">=</span> <span class="va">i</span>,  </span>
<span>      msg <span class="op">=</span> <span class="st">"Algorithm converged"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">fNewton</span><span class="op">(</span><span class="va">fAR1tNegLogLik</span>, <span class="va">fAR1tGrad</span>, <span class="va">fAR1tHess</span>, vY <span class="op">=</span> <span class="va">y_ar</span>, init.vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $params</span></span>
<span><span class="co">#&gt; [1] 0.8557711 1.1124668</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $log_likelihood_opt</span></span>
<span><span class="co">#&gt; [1] 410.3974</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $score_opt</span></span>
<span><span class="co">#&gt; [1] -2.601885e-10  5.501685e-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $hessian_opt</span></span>
<span><span class="co">#&gt;             [,1]       [,2]</span></span>
<span><span class="co">#&gt; [1,] 200.2957152 -0.5986651</span></span>
<span><span class="co">#&gt; [2,]  -0.5986651  9.6342894</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 92</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $msg</span></span>
<span><span class="co">#&gt; [1] "Algorithm converged"</span></span>
<span><span class="va">vPars_temp</span> <span class="op">&lt;-</span> <span class="fu">fNewton</span><span class="op">(</span><span class="va">fAR1tNegLogLik</span>, <span class="va">fAR1tGrad</span>, <span class="va">fAR1tHess</span>, vY <span class="op">=</span> <span class="va">y_ar</span>, init.vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">params</span></span>
<span></span>
<span><span class="va">dPhi_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">tanh</a></span><span class="op">(</span><span class="va">vPars_temp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dNu_star</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vPars_temp</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Phi-est: "</span>, <span class="va">dPhi_star</span>, <span class="st">" vs true: "</span>, <span class="va">phi_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Phi-est: 0.694072436111299 vs true: 0.7"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Nu-est: "</span>, <span class="va">dNu_star</span>, <span class="st">" vs true: "</span>, <span class="va">nu_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Nu-est: 5.04185272789097 vs true: 5"</span></span>
<span></span>
<span><span class="co"># e</span></span>
<span><span class="va">vPars_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">fAR1tNegLogLik</span>, gr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="fu">fAR1tGrad</span><span class="op">(</span><span class="va">fAR1tNegLogLik</span>, <span class="va">par</span>, <span class="va">...</span><span class="op">)</span> <span class="op">}</span>, vY <span class="op">=</span> <span class="va">y_ar</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span><span class="op">$</span><span class="va">par</span></span>
<span></span>
<span><span class="co"># f</span></span>
<span><span class="va">dPhi_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">tanh</a></span><span class="op">(</span><span class="va">vPars_temp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">dNu_star</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">vPars_temp</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Phi-est: "</span>, <span class="va">dPhi_star</span>, <span class="st">" vs true: "</span>, <span class="va">phi_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Phi-est: 1 vs true: 0.7"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Nu-est: "</span>, <span class="va">dNu_star</span>, <span class="st">" vs true: "</span>, <span class="va">nu_true</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Nu-est: 6.97158263449599 vs true: 5"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="zero-inflated-poisson-zip-regression-likelihood-extremely-hard" class="level2" data-number="33.3"><h2 data-number="33.3" class="anchored" data-anchor-id="zero-inflated-poisson-zip-regression-likelihood-extremely-hard">
<span class="header-section-number">33.3</span> <strong>(3) Zero-Inflated Poisson (ZIP) Regression Likelihood (Extremely Hard)</strong>
</h2>
<ul>
<li>A ZIP model assumes that zero outcomes <span class="math inline">\(y_i=0\)</span> can come from two sources:
<ol type="1">
<li>A “certain zero” state (e.g., never uses a service), with probability <span class="math inline">\(\pi_i\)</span>.</li>
<li>A Poisson count process that happens to produce a zero, with probability <span class="math inline">\((1-\pi_i) \cdot P(Count=0|\lambda_i)\)</span>.</li>
</ol>
</li>
<li>The probability mass function is: <span class="math inline">\(P(y_i=k) = \pi_i \cdot I(k=0) + (1-\pi_i) \cdot \frac{e^{-\lambda_i}\lambda_i^k}{k!}\)</span> for <span class="math inline">\(k=0,1,2,\dots\)</span> where <span class="math inline">\(I(k=0)\)</span> is an indicator function (1 if <span class="math inline">\(k=0\)</span>, 0 otherwise).</li>
<li>Often, <span class="math inline">\(\pi_i\)</span> and <span class="math inline">\(\lambda_i\)</span> are modeled with covariates:
<ul>
<li>
<span class="math inline">\(\text{logit}(\pi_i) = \mathbf{w}_i'\boldsymbol{\gamma}\)</span> (Logistic regression for zero-inflation probability)</li>
<li>
<span class="math inline">\(\log(\lambda_i) = \mathbf{x}_i'\boldsymbol{\beta}\)</span> (Log-linear model for Poisson mean)</li>
</ul>
</li>
<li>Parameters: <span class="math inline">\(\boldsymbol{\theta} = (\boldsymbol{\gamma}', \boldsymbol{\beta}')\)</span>.</li>
<li>Data Simulation:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span></span>
<span><span class="va">N_zip</span> <span class="op">&lt;-</span> <span class="fl">250</span></span>
<span><span class="va">W1_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_zip</span><span class="op">)</span>; <span class="va">W_matrix_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">W1_zip</span><span class="op">)</span> <span class="co"># For pi</span></span>
<span><span class="va">X1_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N_zip</span><span class="op">)</span>; <span class="va">X_matrix_zip_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1_zip</span><span class="op">)</span> <span class="co"># For lambda</span></span>
<span>    </span>
<span><span class="va">gamma_true_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0.8</span><span class="op">)</span> <span class="co"># logit(pi) params</span></span>
<span><span class="va">beta_true_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span>   <span class="co"># log(lambda) params</span></span>
<span>    </span>
<span><span class="va">logit_pi_vals</span> <span class="op">&lt;-</span> <span class="va">W_matrix_zip</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">gamma_true_zip</span></span>
<span><span class="va">pi_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">logit_pi_vals</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">logit_pi_vals</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">log_lambda_vals</span> <span class="op">&lt;-</span> <span class="va">X_matrix_zip_lambda</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true_zip</span></span>
<span><span class="va">lambda_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">log_lambda_vals</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">Y_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">N_zip</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i_zip</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_zip</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">pi_vals</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Y_zip</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># Certain zero</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">Y_zip</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda_vals</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span><span class="op">)</span> <span class="co"># From Poisson</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># hist(Y_zip, breaks=-0.5:(max(Y_zip)+0.5)) # Lots of zeros?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<strong>Tasks:</strong>
<ul>
<li><ol type="a">
<li>
<strong>R Likelihood:</strong> Write an R function <code>fZIPNegLogLik(vParams, vY, mW, mX)</code> for the negative log-likelihood. <code>vParams</code> will contain both <span class="math inline">\(\boldsymbol{\gamma}\)</span> and <span class="math inline">\(\boldsymbol{\beta}\)</span>. You need to unpack them carefully.</li>
</ol></li>
<li><ol start="2" type="a">
<li>
<strong>Optimization:</strong> Use <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> (“BFGS” or “Nelder-Mead”) to find the MLEs for <span class="math inline">\(\boldsymbol{\gamma}\)</span> and <span class="math inline">\(\boldsymbol{\beta}\)</span>. This is complex; good starting values are crucial (e.g., <span class="math inline">\(\boldsymbol{\gamma}\)</span> from a logit model predicting <span class="math inline">\(y_i=0\)</span> vs <span class="math inline">\(y_i&gt;0\)</span>, and <span class="math inline">\(\boldsymbol{\beta}\)</span> from a Poisson regression on <span class="math inline">\(y_i[y_i&gt;0]\)</span>).</li>
</ol></li>
<li><ol start="3" type="a">
<li>
<strong>C++ Likelihood (Point calculation):</strong> Implement a C++ function <code>zip_log_lik_point_cpp(int yi, double logit_pi_i, double log_lambda_i)</code> that calculates the log-likelihood for a single observation <span class="math inline">\(y_i\)</span>, given its specific <span class="math inline">\(\text{logit}(\pi_i)\)</span> and <span class="math inline">\(\log(\lambda_i)\)</span>. Use <code>R::pnorm</code> (for logit to prob), <code>R::dpois</code>.</li>
</ol></li>
<li><ol start="4" type="a">
<li>
<strong>Full C++ Likelihood (Loop):</strong> Write a C++ function <code>fZIPNegLogLikCpp(arma::vec vGamma, arma::vec vBeta, arma::ivec vY, arma::mat mW, arma::mat mX)</code> that calculates the total negative log-likelihood by iterating through observations and calling a C++ point likelihood (or calculating directly). This will require computing <span class="math inline">\(\mathbf{w}_i'\boldsymbol{\gamma}\)</span> and <span class="math inline">\(\mathbf{x}_i'\boldsymbol{\beta}\)</span> for each <span class="math inline">\(i\)</span>.</li>
</ol></li>
<li><ol start="5" type="a">
<li>
<strong>Comparison:</strong> Compare the speed of a single evaluation of your R and C++ full likelihood functions.</li>
</ol></li>
<li><ol start="6" type="a">
<li>
<strong>Package (Conceptual):</strong> If you were to package this, what would be the main user-facing R function? What arguments would it take? What would it return? How would you handle the C++ code?</li>
</ol></li>
</ul>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span></span>
<span><span class="va">N_zip</span> <span class="op">&lt;-</span> <span class="fl">250</span></span>
<span><span class="va">W1_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_zip</span><span class="op">)</span>; <span class="va">W_matrix_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">W1_zip</span><span class="op">)</span> <span class="co"># For pi</span></span>
<span><span class="va">X1_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N_zip</span><span class="op">)</span>; <span class="va">X_matrix_zip_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">X1_zip</span><span class="op">)</span> <span class="co"># For lambda</span></span>
<span>    </span>
<span><span class="va">gamma_true_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0.8</span><span class="op">)</span> <span class="co"># logit(pi) params</span></span>
<span><span class="va">beta_true_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span>   <span class="co"># log(lambda) params</span></span>
<span>    </span>
<span><span class="va">logit_pi_vals</span> <span class="op">&lt;-</span> <span class="va">W_matrix_zip</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">gamma_true_zip</span></span>
<span><span class="va">pi_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">logit_pi_vals</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">logit_pi_vals</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">log_lambda_vals</span> <span class="op">&lt;-</span> <span class="va">X_matrix_zip_lambda</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_true_zip</span></span>
<span><span class="va">lambda_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">log_lambda_vals</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">Y_zip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">N_zip</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i_zip</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_zip</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">pi_vals</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Y_zip</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># Certain zero</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">Y_zip</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda_vals</span><span class="op">[</span><span class="va">i_zip</span><span class="op">]</span><span class="op">)</span> <span class="co"># From Poisson</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#a</span></span>
<span><span class="va">fZIPNegLogLik</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vParams</span>, <span class="va">vY</span>, <span class="va">mW</span>, <span class="va">mX</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vGamma</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mW</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">vBeta</span> <span class="op">&lt;-</span> <span class="va">vParams</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mW</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mW</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">mX</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">logit_pi_i</span> <span class="op">&lt;-</span> <span class="va">mW</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vGamma</span></span>
<span>  <span class="va">pi_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span><span class="va">logit_pi_i</span><span class="op">)</span></span>
<span>  <span class="va">log_lambda_i</span> <span class="op">&lt;-</span> <span class="va">mX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">vBeta</span></span>
<span>  <span class="va">lambda_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">log_lambda_i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">vY</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">pi_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pi_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">lambda_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">^</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">factorial</a></span><span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">dSum</span> <span class="op">&lt;-</span> <span class="va">dSum</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pi_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lambda_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">lambda_i</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">^</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html">factorial</a></span><span class="op">(</span><span class="va">vY</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">dSum</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">fZIPNegLogLik</span>, vY <span class="op">=</span> <span class="va">Y_zip</span>, mW <span class="op">=</span> <span class="va">W_matrix_zip</span>, mX <span class="op">=</span> <span class="va">X_matrix_zip_lambda</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -1.0449956  0.6241883  0.5144958  1.5029647</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 490.5832</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       26       10 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./extra_extra_exercises.html" class="pagination-link" aria-label="Extra extra exercises">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Extra extra exercises</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>